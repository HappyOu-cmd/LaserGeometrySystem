# КОНТЕКСТ ПРОЕКТА - ЛАЗЕРНАЯ ГЕОМЕТРИЯ

## ОСНОВНАЯ ЗАДАЧА
Создание системы измерения геометрии с 4 триангуляционными лазерными датчиками РФ602, интегрированной с Modbus сервером и автоматом состояний.

## АРХИТЕКТУРА СИСТЕМЫ

### 1. ДАТЧИКИ
- **4 датчика РФ602** (триангуляционные лазерные)
- **QUAD режим**: синхронный опрос всех 4 датчиков (~125 Гц)
- **Потоковые режимы**: опрос отдельных датчиков (~1000+ Гц)
- **Протокол**: RIFTEK по RS485, baudrate 921600

### 2. MODBUS СЕРВЕР
**Holding Registers (40001+):**
- 40001: CMD команда от ПЛК (0=стоп, 10=стенка, 11=фланец, 12=дно)
- 40002-40007: Эталонные значения (толщина стенки, дна, диаметр)
- 40010-40019: Расстояния между датчиками и до центра

**Input Registers (30001+):**
- 30001-30008: Текущие расстояния от датчиков 1-4
- 30010-30015: Рассчитанные толщины (стенка, фланец, дно)

### 3. АВТОМАТ СОСТОЯНИЙ
Состояния меняются по значению Holding Register 40001 (CMD):
- IDLE (ожидание) - CMD = 0
- CALIBRATE_WALL (калибровка стенки) - CMD = 100
- CALIBRATE_BOTTOM (калибровка дна) - CMD = 101
- CALIBRATE_FLANGE (калибровка фланца) - CMD = 102
- MEASURE_WALL (измерение верхней стенки) - CMD = 10
- MEASURE_FLANGE (измерение фланца и дна) - CMD = 11
- MEASURE_BOTTOM (измерение нижней стенки и диаметра) - CMD = 12
- STREAM_SENSOR1-4 (потоковые режимы) - CMD = 200-203
- ERROR (ошибка)

### 4. МЕТОДИКА КАЛИБРОВКИ

#### КАЛИБРОВКА СТЕНКИ (CMD = 100)
1. **Читаем** из регистров 40002, 40003 толщину эталона стенки (float в двух регистрах)
2. **Измеряем** датчиками 1,2,3 не менее 4 секунд
3. **Усредняем** все измерения по каждому датчику
4. **Вычисляем** расстояние между датчиками 1,2:
   ```
   Расстояние_между_датчиками_1_2 = d1_avg + d2_avg + толщина_эталона
   ```
5. **Вычисляем** расстояние между датчиками 1,3:
   ```
   Расстояние_между_датчиками_1_3 = d1_avg - d3_avg
   ```
   где d1_avg, d2_avg, d3_avg - усредненные значения (уже с базовым расстоянием 20мм)
6. **Записываем** результат 1,2 в регистры 40010, 40011 (float в двух регистрах)
7. **Записываем** результат 1,3 в регистры 40012, 40013 (float в двух регистрах)
8. **Точность**: 3 знака после запятой (отображение)

#### ДОПОЛНИТЕЛЬНЫЕ КАЛИБРОВКИ
- CMD = 101: калибровка фланца (будет добавлена позже)
- CMD = 102: калибровка дна (будет добавлена позже)

## СУЩЕСТВУЮЩИЕ ФАЙЛЫ
- `main.py` - протокол опроса датчиков (работает отлично)
- `modbus_slave_server.py` - логика Modbus сервера
- `gui_sensors_simple_optimized.py` - GUI интерфейс
- `laser_geometry_system.py` - **ОСНОВНОЙ ФАЙЛ ПРОЕКТА** (автомат состояний + интеграция)
- `modbus_debug_gui.py` - **GUI для отладки Modbus регистров** (интегрирован в основную систему)
- `modbus_database.py` - **Модуль базы данных SQLite** для сохранения регистров
- `modbus_database_integration.py` - **Интеграция БД с Modbus сервером**


## ОСНОВНОЙ ЦИКЛ ИЗМЕРЕНИЯ (НОВАЯ ЛОГИКА С РАЗДЕЛЕНИЕМ ПРОЦЕССОВ)

### АРХИТЕКТУРА ДВУХЭТАПНОГО ЦИКЛА
Каждое измерение разделено на два этапа:
1. **PROCESS (сбор данных)** - HMI отправляет команду измерения, система собирает данные
2. **CALCULATE (подсчёт)** - HMI отправляет команду подсчёта, система обрабатывает и выдаёт результаты

Это даёт HMI полный контроль над длительностью измерения и моментом расчёта результатов.

### ПОСЛЕДОВАТЕЛЬНОСТЬ КОМАНД И СТАТУСОВ

```
IDLE (CMD=0, STATUS 30009=0) - готов к работе
    ↓ HMI: CMD=9 (опционально)
    
ВЫСОТА - ПОИСК ПРЕПЯТСТВИЯ (CMD=9, STATUS=9) - датчик 1 ищет препятствие
    → STATUS=90 (препятствие найдено, сбор данных)
    → STATUS=91 (высота рассчитана, готов к CMD=10)
    ↓ HMI: CMD=10
    
ВЕРХНЯЯ СТЕНКА - ИЗМЕРЕНИЕ (CMD=10, STATUS=10) - сбор данных
    ↓ HMI: CMD=11
    
ВЕРХНЯЯ СТЕНКА - ПОДСЧЁТ (CMD=11, STATUS=11) - расчёт результатов
    → STATUS=110 (готов к следующей команде)
    ↓ HMI: CMD=12
    
ФЛАНЕЦ - ИЗМЕРЕНИЕ (CMD=12, STATUS=12) - сбор данных
    ↓ HMI: CMD=13
    
ФЛАНЕЦ - ПОДСЧЁТ (CMD=13, STATUS=13) - расчёт результатов
    → STATUS=112 (готов к следующей команде)
    ↓ HMI: CMD=14
    
НИЖНЯЯ СТЕНКА - ИЗМЕРЕНИЕ (CMD=14, STATUS=14) - сбор данных
    ↓ HMI: CMD=15
    
НИЖНЯЯ СТЕНКА - ПОДСЧЁТ (CMD=15, STATUS=15) - расчёт результатов
    → STATUS=114 (готов к следующей команде)
    ↓ HMI: CMD=16
    
ОЦЕНКА КАЧЕСТВА (CMD=16, STATUS=16) - проверка 7 параметров
    → STATUS=116 (готов к завершению)
    ↓ HMI: CMD=0
    
IDLE (CMD=0, STATUS=0) - цикл завершён
```

### СТАТУСЫ РЕГИСТРА 30009 (ОБРАТНАЯ СВЯЗЬ ДЛЯ HMI)

| Статус | Описание | Следующая команда |
|--------|----------|-------------------|
| **0** | Готов к работе | CMD=9 или CMD=10 |
| **9** | Поиск препятствия (высота) | Автоматически → 90 |
| **90** | Препятствие найдено, сбор данных | Автоматически → 91 |
| **91** | Высота рассчитана | CMD=10 |
| **10** | Идёт измерение верхней стенки | CMD=11 (когда готов) |
| **11** | Идёт подсчёт верхней стенки | Ждём 110 |
| **110** | Подсчёт завершён, данные готовы | CMD=12 |
| **12** | Идёт измерение фланца | CMD=13 (когда готов) |
| **13** | Идёт подсчёт фланца | Ждём 112 |
| **112** | Подсчёт завершён, данные готовы | CMD=14 |
| **14** | Идёт измерение нижней стенки | CMD=15 (когда готов) |
| **15** | Идёт подсчёт нижней стенки | Ждём 114 |
| **114** | Подсчёт завершён, данные готовы | CMD=16 |
| **16** | Идёт оценка качества | Ждём 116 |
| **116** | Оценка завершена | CMD=0 (возврат в IDLE) |
| **-1** | Ошибка / прерывание цикла | CMD=0 |

### КОМАНДЫ ОСНОВНОГО ЦИКЛА

#### CMD=9: Измерение высоты
- **Действие**: Поиск препятствия датчиком 1, расчет высоты
- **Статус 30009**: 9 → 90 → 91
- **Логика**:
  1. Пока датчик 1 = 0 → поиск препятствия
  2. 5 ненулевых показаний подряд → препятствие найдено (STATUS=90)
  3. Сбор 50 измерений высоты
  4. Расчет по формуле: `Высота = Дистанция_до_плоскости(40022-40023) - (Шаги(40020) / Импульсы_на_мм(40021))`
  5. Запись макс/сред/мин в 30040-30045 (STATUS=91)

#### CMD=10: Начало измерения верхней стенки
- **Действие**: Запуск QUAD режима датчиков 1,2, непрерывный сбор данных
- **Статус 30009**: 10
- **Длительность**: Контролируется HMI (отправка CMD=11)

#### CMD=11: Подсчёт результатов верхней стенки
- **Действие**: Остановка сбора, расчёт макс/сред/мин, запись в 30016-30021
- **Статус 30009**: 11 → 110 (готово)
- **Формула**: `Толщина = Расстояние_1_2 (40010-40011) - Датчик1 - Датчик2`

#### CMD=12: Начало измерения фланца
- **Действие**: Запуск QUAD режима датчиков 1,3,4, непрерывный сбор данных
- **Статус 30009**: 12
- **Длительность**: Контролируется HMI (отправка CMD=13)

#### CMD=13: Подсчёт результатов фланца
- **Действие**: Остановка сбора, расчёт и запись в регистры:
  - Диаметр корпуса: 30046-30051
  - Диаметр фланца: 30052-30057
  - Толщина фланца: 30034-30039
  - Толщина дна: 30028-30033
- **Статус 30009**: 13 → 112 (готово)

#### CMD=14: Начало измерения нижней стенки
- **Действие**: Запуск QUAD режима датчиков 1,2, непрерывный сбор данных
- **Статус 30009**: 14
- **Длительность**: Контролируется HMI (отправка CMD=15)

#### CMD=15: Подсчёт результатов нижней стенки
- **Действие**: Остановка сбора, расчёт макс/сред/мин, запись в 30022-30027
- **Статус 30009**: 15 → 114 (готово)
- **Формула**: `Толщина = Расстояние_1_2 (40010-40011) - Датчик1 - Датчик2`

#### CMD=16: Оценка качества изделия
- **Действие**: 
  - Проверка 7 параметров (высота, верхняя стенка, нижняя стенка, дно, толщина фланца, диаметр корпуса, диаметр фланца)
  - Определение GOOD/CONDITIONALLY_GOOD/BAD
  - Обновление счётчиков 30101-30104
  - Инкремент номера изделия 40101
  - Сохранение в БД
- **Статус 30009**: 16 → 116 (готово)

### ОБРАБОТКА ОШИБОК ДАТЧИКОВ
- **Консервативный подход**: записываются только полностью валидные измерения
- **При ошибке любого нужного датчика**: измерение полностью игнорируется
- **Диагностика**: выводится сообщение с указанием проблемного датчика
- **Качество данных**: высокое (только корректные измерения)

### ПРЕРЫВАНИЕ ЦИКЛА И СБРОС ОШИБОК

#### Прерывание цикла
Если во время активного цикла HMI отправляет CMD=0 (не из состояния 16):
- **Статус 30009**: -1 (ошибка)
- **Действие**: Очистка буферов, возврат в IDLE
- **Применение**: Аварийная остановка, отмена дефектного измерения

#### Сброс ошибок
- **Регистр**: 40024
- **Логика**: Если HMI записывает 1 в регистр 40024:
  1. Система сбрасывает флаг состояния 30009 в 0
  2. Автоматически сбрасывает 40024 обратно в 0
  3. Применяется для выхода из зависших состояний

## СТАТУС
- [x] Анализ требований
- [x] Изучение регистров
- [x] Изучение методики калибровки
- [x] Добавление калибровки стенки (CMD=100)
- [x] Калибровка дна (CMD=101) и фланца (CMD=102)
- [x] Создание автомата состояний
- [x] Реализация QUAD режима
- [x] Создание основной программы (laser_geometry_system.py)
- [x] Создание GUI для отладки Modbus регистров
- [x] ИСПРАВЛЕНО: Modbus сервер в laser_geometry_system.py теперь работает
- [x] Исправлена интеграция Modbus сервера в основную систему
- [x] Исправлена работа с float значениями в Modbus регистрах
- [x] Исправлена совместимость с HMI панелью (порядок регистров)
- [x] Добавлен автоматический сброс команды после калибровки
- [x] Протестирована калибровка стенки (CMD=100)
- [x] Добавлена калибровка расстояния 1,3 в команду 100
- [x] Реализована база данных SQLite для сохранения регистров
- [x] Автоматическое сохранение и загрузка всех регистров
- [x] Реализованы потоковые режимы (CMD=200-203)
- [x] **ЗАВЕРШЕНО**: Реализация основного цикла измерения (CMD=10-12)
- [x] Реализация команды 10 (измерение верхней стенки)
- [x] Реализация команды 11 (измерение фланца и дна)
- [x] Реализация команды 12 (измерение нижней стенки)
- [x] Системные оптимизации (высокий приоритет, таймер, питание)
- [x] Исправлено управление соединениями датчиков
- [x] Добавлены все регистры результатов в базу данных (30016-30057)
- [ ] **ГОТОВО К ТЕСТИРОВАНИЮ**: Полный цикл 0→10→11→12→0

## РЕАЛИЗОВАННЫЕ ФУНКЦИИ

### 1. ОСНОВНАЯ СИСТЕМА (laser_geometry_system.py)
- ✅ **Автомат состояний** - полная реализация всех состояний
- ✅ **Интеграция Modbus сервера** - работает без GUI
- ✅ **Калибровка стенки (CMD=100)** - полная реализация с 4-секундным измерением
- ✅ **Калибровка дна (CMD=101)** - полная реализация
- ✅ **Калибровка фланца (CMD=102)** - полная реализация
- ✅ **Основной цикл измерения (CMD=10-12)** - полная реализация
- ✅ **Потоковые режимы (CMD=200-203)** - все 4 датчика
- ✅ **Чтение эталонных значений** - из регистров 40002-40007 (DoubleWord float)
- ✅ **Запись результатов калибровки** - в регистры 40010-40017 (DoubleWord float)
- ✅ **Запись результатов измерений** - в регистры 30016-30057 (DoubleWord float)
- ✅ **Автоматический сброс команды** - после завершения калибровки
- ✅ **Управление циклом измерения** - флаг в регистре 30010
- ✅ **Усреднение измерений** - каждые 10 измерений для точности
- ✅ **Обработка ошибок датчиков** - консервативный подход
- ✅ **Совместимость с HMI** - правильный порядок регистров
- ✅ **Системные оптимизации** - высокий приоритет, таймер, питание
- ✅ **Правильное управление соединениями** - корректное закрытие портов
- ✅ **Работа с реальными датчиками** - стабильные QUAD измерения

### 2. DEBUG GUI (modbus_debug_gui.py)
- ✅ **Отображение Modbus регистров** - все Holding и Input регистры
- ✅ **Float Values** - правильное отображение DoubleWord float значений
- ✅ **Управление Float Values** - добавление и удаление пар регистров
- ✅ **Совместимость с HMI** - правильный порядок регистров
- ✅ **Обновление в реальном времени** - мониторинг изменений
- ✅ **Интеграция с базой данных** - автоматическое сохранение настроек

### 3. MODBUS СЕРВЕР (modbus_slave_server.py)
- ✅ **Версия без GUI** - для интеграции в основную систему
- ✅ **DoubleWord float** - правильное хранение float значений
- ✅ **Совместимость с HMI** - правильный порядок регистров

### 4. БАЗА ДАННЫХ (modbus_database.py + modbus_database_integration.py)
- ✅ **SQLite база данных** - автоматическое сохранение всех регистров
- ✅ **Мониторинг изменений** - автоматическое сохранение при изменениях
- ✅ **Загрузка при запуске** - восстановление всех регистров после перезапуска
- ✅ **Поддержка DoubleWord** - правильное сохранение float значений
- ✅ **Резервное копирование** - создание и восстановление бэкапов
- ✅ **Расширяемость** - легко добавлять новые регистры

## ТЕХНИЧЕСКИЕ ДЕТАЛИ

### ПОРЯДОК РЕГИСТРОВ ДЛЯ HMI
- **HMI отправляет**: старший регистр в 40002, младший в 40003
- **HMI читает**: старший регистр из 40010, младший из 40011
- **Наша система**: правильно интерпретирует и записывает данные

### ТОЧНОСТЬ ИЗМЕРЕНИЙ
- **Float значения**: 3 знака после запятой
- **Единицы измерения**: миллиметры (мм)
- **Формат хранения**: DoubleWord float в Modbus регистрах

### КАЛИБРОВКА СТЕНКИ
- **Время измерения**: 4 секунды
- **Датчики**: 1, 2 и 3 (QUAD режим)
- **Формула 1,2**: `d1_avg + d2_avg + толщина_эталона`
- **Формула 1,3**: `d1_avg - d3_avg`
- **Результат 1,2**: записывается в регистры 40010-40011
- **Результат 1,3**: записывается в регистры 40012-40013

### БАЗА ДАННЫХ
- **Тип БД**: SQLite (файловая база данных)
- **Автоматическое сохранение**: при любых изменениях регистров
- **Автоматическая загрузка**: при запуске системы
- **Мониторинг**: каждую секунду проверка изменений
- **Резервное копирование**: создание и восстановление бэкапов
- **Файл БД**: `modbus_registers.db` в корне проекта

## ПРОМПТ ДЛЯ НОВОГО ЧАТА
```
Прочитай файл PROJECT_CONTEXT.md в папке проекта и продолжи работу над системой лазерной геометрии.

ВАЖНО: Следуй всем инструкциям из раздела "КЛЮЧЕВЫЕ ИНСТРУКЦИИ ПОЛЬЗОВАТЕЛЯ" в PROJECT_CONTEXT.md:
- НЕ плодить много файлов, только самое необходимое
- НЕ нужен километровый код, только суть  
- Уточнять перед реализацией - верно ли понимаю суть
- Не выдумывать ничего от себя - только то, что явно указано
- Держать контекст задачи - всегда ссылаться на этот файл
- НЕ использовать эмодзи - проблемы с кодировкой в Windows

Контекст: У меня система из 4 триангуляционных лазерных датчиков РФ602, нужно создать основную программу с Modbus сервером и автоматом состояний. Все детали в PROJECT_CONTEXT.md.

Текущий статус: 
- ✅ Основная система laser_geometry_system.py полностью работает
- ✅ Modbus сервер интегрирован и работает корректно
- ✅ Калибровка стенки (CMD=100) реализована и протестирована
- ✅ Debug GUI работает с правильным отображением float значений
- ✅ Совместимость с HMI панелью обеспечена
- ✅ Автоматический сброс команды после калибровки
- ✅ Добавлена калибровка расстояния 1,3 в команду 100
- ✅ Реализована база данных SQLite для сохранения регистров
- ✅ Автоматическое сохранение и загрузка всех регистров
- ✅ Система готова к работе с реальными датчиками

## ИТОГИ РЕАЛИЗАЦИИ

### ПОЛНОСТЬЮ ЗАВЕРШЕННЫЕ МОДУЛИ:
- ✅ **Основная система** - laser_geometry_system.py (2100+ строк)
- ✅ **Все калибровки** - CMD=100, 101, 102
- ✅ **Основной цикл измерения** - CMD=10-16 (НОВАЯ ДВУХЭТАПНАЯ АРХИТЕКТУРА)
- ✅ **Потоковые режимы** - CMD=200, 201, 202, 203
- ✅ **Система контроля качества** - автоматическая оценка изделий
- ✅ **Modbus сервер** - полная интеграция
- ✅ **Debug GUI** - с управлением Float Values и автообновлением
- ✅ **База данных SQLite** - автоматическое сохранение всех регистров
- ✅ **История измерений** - таблица measurement_history для всех изделий
- ✅ **Расширенные регистры** - 40352-40403 (пороговые значения)
- ✅ **Регистры смены и изделий** - 40100, 40101
- ✅ **Счётчики изделий** - 30101-30104 (всего, годных, условно-годных, негодных)
- ✅ **Статусная обратная связь** - регистр 30010 с детальными статусами (10, 11, 110, 12, 13, 112, 14, 15, 114, 16, 116)

### КЛЮЧЕВЫЕ ДОСТИЖЕНИЯ:
- **Стабильные измерения** - исправлены проблемы с датчиками
- **Системные оптимизации** - высокий приоритет, таймер 1мс, отключение спящего режима
- **Правильное управление соединениями** - корректное закрытие портов
- **Консервативная обработка ошибок** - только валидные измерения
- **Полная совместимость с HMI** - правильный порядок регистров
- **Усреднение каждых 10 измерений** - высокая точность результатов
- **Автообновление GUI** - чтение напрямую из Modbus сервера каждую секунду
- **Автоинкремент номера изделия** - при успешном завершении цикла
- **Автоматический контроль качества** - оценка изделий по 4 параметрам (12 проверок)
- **Гибкие настройки проверки** - выбор режима (все/среднее/макс+сред/мин+сред)
- **Допуски ошибок** - настраиваемые пороги для условно-годных и негодных проверок
- **История измерений** - полная запись всех измерений с результатами проверок
- **Автосброс счётчиков** - при смене номера смены
- **НОВОЕ: Двухэтапная архитектура** - разделение сбора данных и подсчёта результатов
- **НОВОЕ: Полный контроль HMI** - HMI управляет длительностью каждого измерения
- **НОВОЕ: Детальная обратная связь** - статусы 10/110, 12/112, 14/114, 16/116 для каждого этапа
- **НОВОЕ: Гибкое управление циклом** - возможность прерывания на любом этапе

### СИСТЕМА КОНТРОЛЯ КАЧЕСТВА:

#### ЛОГИКА ПРОВЕРКИ:
1. **4 параметра проверяются**: Верхняя стенка, Толщина фланца, Диаметр корпуса, Диаметр фланца
2. **По 3 значения каждый**: Максимальное, Среднее, Минимальное (всего 12 проверок)
3. **Диапазоны оценки**:
   - ГОДНАЯ: `[база + усл_негодная, база]`
   - УСЛОВНО-ГОДНАЯ: `[база + негодная, база + усл_негодная)`
   - НЕГОДНАЯ: `< база + негодная` или `> база`

#### НАСТРОЙКИ (Holding регистры):
- **40049** - Режим проверки (0=все, 1=среднее, 2=макс+сред, 3=мин+сред)
- **40050** - Допустимое количество условно-годных ошибок
- **40051** - Допустимое количество негодных ошибок

#### РЕЗУЛЬТАТ:
- Если **негодных > допустимых** → НЕГОДНАЯ
- Иначе если **условно-годных > допустимых** → УСЛОВНО-ГОДНАЯ
- Иначе → ГОДНАЯ

#### СЧЁТЧИКИ (Input регистры):
- **30101** - Количество изделий за смену (всего)
- **30102** - Количество годных изделий
- **30103** - Количество условно-годных изделий
- **30104** - Количество негодных изделий

### ПОЛНЫЙ СПИСОК РЕГИСТРОВ:

#### HOLDING REGISTERS (40001+) - 72+ регистра:
- **40001** - CMD команда от ПЛК
- **40002-40007** - Эталонные значения (толщина стенки, дна, диаметр)
- **40010-40019** - Калибровочные расстояния между датчиками
- **40020-40023** - Параметры измерения высоты (шаги, импульсы/мм, дистанция до плоскости)
- **40024** - Сброс ошибок (1=сбросить флаг 30009 в 0)
- **40049-40051** - Настройки контроля качества (режим проверки, допуски)
- **40100-40101** - Производство (смена, номер изделия)
- **40352-40357** - Пороги верхней стенки (базовое, условно-годное, негодное)
- **40358-40363** - Пороги нижней стенки (базовое, условно-годное, негодное)
- **40364-40369** - Пороги дна (базовое, условно-годное, негодное)
- **40370-40375** - Пороги толщины фланца
- **40376-40381** - Пороги высоты
- **40382-40387** - Пороги диаметра корпуса
- **40388-40393** - Пороги диаметра фланца
- **40400-40403** - Положительные погрешности для дна и нижней стенки (двусторонняя проверка)

#### INPUT REGISTERS (30001+) - 50+ регистров:
- **30001-30008** - Текущие расстояния датчиков 1-4 (DoubleWord float)
- **30009** - Флаг цикла измерения (статус системы)
- **30010-30015** - Последние рассчитанные толщины
- **30016-30021** - Результаты верхней стенки (макс/сред/мин)
- **30022-30027** - Результаты нижней стенки (макс/сред/мин)
- **30028-30033** - Результаты дна (макс/сред/мин)
- **30034-30039** - Результаты толщины фланца (макс/сред/мин)
- **30040-30045** - Результаты высоты (макс/сред/мин)
- **30046-30051** - Результаты диаметра корпуса (макс/сред/мин)
- **30052-30057** - Результаты диаметра фланца (макс/сред/мин)
- **30101-30104** - Счётчики изделий за смену (всего, годных, условно-годных, негодных)

#### КОМАНДЫ СИСТЕМЫ - 15 команд:
- **0** - IDLE / Стоп
- **9** - Измерение высоты (поиск препятствия, расчет)
- **10** - Измерение верхней стенки (сбор данных)
- **11** - Подсчёт верхней стенки (обработка результатов)
- **12** - Измерение фланца (сбор данных)
- **13** - Подсчёт фланца (обработка результатов)
- **14** - Измерение нижней стенки (сбор данных)
- **15** - Подсчёт нижней стенки (обработка результатов)
- **16** - Оценка качества изделия (7 параметров)
- **100-102** - Калибровки (стенка, дно, фланец)
- **200-203** - Потоковые режимы (датчики 1-4)

### ГОТОВО К ЭКСПЛУАТАЦИИ:
Система полностью готова к работе с реальными датчиками РФ602 и HMI панелью.

**Полный цикл измерения** 0→9(9/90/91)→10→11(110)→12→13(112)→14→15(114)→16(116)→0 реализован с:
- **Измерением высоты** - опциональный первый этап с автоматическим поиском препятствия
- **Двухэтапной архитектурой** - разделение измерения и подсчёта
- **Полным контролем HMI** - управление длительностью каждого этапа
- **Детальной обратной связью** - статусы процесса и готовности (9/90/91, 10/110, 12/112, 14/114, 16/116)
- **Контролем качества** - проверка 7 параметров с односторонними и двусторонними допусками
- **Автоматическим подсчетом изделий** - счетчики годных/условно-годных/негодных
- **Сбросом ошибок** - регистр 40024 для выхода из зависших состояний

## КОНТРОЛЬ КАЧЕСТВА (CMD=16)

### ПРОВЕРЯЕМЫЕ ПАРАМЕТРЫ (7 параметров):

1. **Высота** (30040-30045)
   - Односторонняя проверка
   - Пороги: 40376-40381

2. **Верхняя стенка** (30016-30021)
   - Односторонняя проверка
   - Пороги: 40352-40357

3. **Нижняя стенка** (30022-30027)
   - **Двусторонняя проверка** 
   - Пороги: 40358-40363, 40402-40403 (положительная погрешность)

4. **Дно** (30028-30033)
   - **Двусторонняя проверка**
   - Пороги: 40364-40369, 40400-40401 (положительная погрешность)

5. **Толщина фланца** (30034-30039)
   - Односторонняя проверка
   - Пороги: 40370-40375

6. **Диаметр корпуса** (30046-30051)
   - Односторонняя проверка
   - Пороги: 40382-40387

7. **Диаметр фланца** (30052-30057)
   - Односторонняя проверка
   - Пороги: 40388-40393

### ЛОГИКА ПРОВЕРКИ:

#### Односторонняя проверка (5 параметров):
```
НЕГОДНАЯ:          measured < (base + bad_error)
УСЛОВНО-ГОДНАЯ:    (base + bad_error) ≤ measured < (base + cond_bad_error)
ГОДНАЯ:            (base + cond_bad_error) ≤ measured ≤ base
НЕГОДНАЯ:          measured > base
```

#### Двусторонняя проверка (2 параметра: нижняя стенка, дно):
```
НЕГОДНАЯ:          measured < (base + bad_error)
УСЛОВНО-ГОДНАЯ:    (base + bad_error) ≤ measured < (base + cond_bad_error)
ГОДНАЯ:            (base + cond_bad_error) ≤ measured ≤ (base + positive_bad_error)
НЕГОДНАЯ:          measured > (base + positive_bad_error)
```

### РЕЖИМЫ ПРОВЕРКИ (40049):
- **0** - Проверять все значения (макс, сред, мин)
- **1** - Проверять только среднее
- **2** - Проверять макс + сред
- **3** - Проверять мин + сред

### ИТОГОВАЯ ОЦЕНКА:
```
if (негодных_параметров > допуск_негодных_40051):
    РЕЗУЛЬТАТ = НЕГОДНОЕ
elif (условно_годных_параметров > допуск_условно_годных_40050):
    РЕЗУЛЬТАТ = УСЛОВНО-ГОДНОЕ
else:
    РЕЗУЛЬТАТ = ГОДНОЕ
```

### СЧЕТЧИКИ ИЗДЕЛИЙ (30101-30104):
- Автоматически обновляются при CMD=16
- Сбрасываются при смене смены (изменение 40100)
- Сохраняются в БД для статистики

### БАЗА ДАННЫХ:
Таблица `measurement_history` хранит для каждого изделия:
- Смена, номер изделия, время
- Все измеренные значения (макс/сред/мин) для 7 параметров
- Статусы каждого параметра
- Итоговый результат
- Настройки проверки

## ОПТИМИЗАЦИИ ПРОИЗВОДИТЕЛЬНОСТИ

### Реализованные оптимизации:
1. **Кеширование калиброванных расстояний** - загружаются один раз в начале каждого этапа измерения
2. **Минимизация Modbus чтений** - удалено `get_current_command()` из горячих циклов
3. **Оптимизация вывода** - частота print() снижена с каждых 10 до каждых 100 измерений
4. **Удаление sleep()** - убрано `time.sleep(0.01)` из обработчиков ошибок
5. **Флаги однократного выполнения** - расчеты (CMD 11, 13, 15, 16) выполняются строго один раз
6. **Защита от повторных вызовов** - `previous_cmd` предотвращает сброс статуса при повторной отправке той же команды
7. **Мониторинг частоты** - отображение реальной частоты опроса (Гц) для контроля производительности

### Достигнутые результаты:
- Частота измерений в QUAD режиме: ~200-250 Гц (4 датчика одновременно)
- Частота в режиме высоты (1 датчик): ~200+ Гц
- Корректная работа всех расчетов без дублирования

## ФАЙЛЫ ПРОЕКТА

### Основные файлы:
- **laser_geometry_system.py** (2800+ строк) - основная система с автоматом состояний
- **modbus_slave_server.py** (820+ строк) - Modbus TCP/IP сервер
- **modbus_debug_gui.py** (450 строк) - GUI мониторинга регистров
- **modbus_database.py** (735 строк) - SQLite база данных
- **modbus_database_integration.py** (397 строк) - интеграция БД с Modbus
- **main.py** - протокол датчиков RF602
- **Modbus_Registers_Full.xlsx** - документация всех регистров

### Вспомогательные файлы:
- **requirements.txt** - зависимости проекта
- **PROJECT_CONTEXT.md** - этот файл (документация)

Всего **72 Holding + 50+ Input = 120+ регистров** настроены и готовы к использованию.
